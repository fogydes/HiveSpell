// Word Lists by Difficulty
const BABY_TEXT = `Air
Heir
Baby
Bad
Bag
Ball
Bawl
Bar
Bat
Bee
Be
Best
Big
Bird
Blue
Blew
Book
Bug
Bus
Cake
Car
Cat
Cool
Cry
Cup
Dad
Dog
Duck
Eat
Elf
End
Eye
Aye
Face
Fire
Fish
Phish
Foot
Gold
Hand
Kiss
Milk
Mix
Mom
Moon
Mug
Noob
Newb
Pie
Pi
Pink
Rain
Reign
Rat
Red
Read
Ruby
Run
Sit
Size
Sighs
Snow
Soda
Star
Suck
Sun
Son
Tag
Tank
Tap
Town
Tree
Water
Wind
Word
Zoo`;

const CAKEWALK_TEXT = `Absorb
Angel
Ash
Bingo
Black
Boss
Brain
Burger
Burial
Cabin
Circle
Clever
Cliff
Clutch
Comply
Convey
Crowd
Dairy
Defy
Demon
Echo
Emoji
Erupt
Exert
Exile
Film
Filter
Flower
Flour
Foggy
Forbid
Gender
Ghost
Giant
Greedy
Green
Grub
Hello
Hotel
House
Human
Hungry
Ink
Intent
Iron
Irony
Land
Length
Margin
Melt
Meow
Monk
Noble
Nobel
Orange
Pasta
Pear
Pair
Power
Prank
Pray
Prey
Proof
Quack
Quill
Rally
Random
Reply
Robust
Rot
Wrought
Shake
Shark
Sigh
Psi
Sock
State
Stew
Still
Stumble
Trauma
Twist
Update
Vein
Vain
Walk
Way
Weigh
White
Workout
Wrist`;

const LEARNER_TEXT = `Abolish
Absence
Abstract
Agaric
Agnostic
Akin
Albeit
Alliance
Alphabet
Anatomical
Answer
Appetite
Armor
Armour
Atone
Automatic
Await
Bamboo
Bayonet
Betray
Biography
Bizarre
Breakthrough
Broccoli
Catalog
Catalogue
Center
Centre
Chicken
Chronic
Church
Congratulate
Cooking
Curious
Damage
Debris
Diesel
Dilate
Dolphin
Enact
Excellent
Familiar
Firefighter
Flavor
Flavour
Formidable
Frolic
Furious
Gallant
Gradual
Guideline
Harbor
Harbour
Heresy
Immobilize
Immobilise
Integrity
Ionize
Ionise
Lactose
Lather
Leafy
Liable
Lightning
Magnificent
Meditate
Normal
Oasis
Obesity
Offender
Overdue
Overdo
Paradox
Password
Pigeon
Pidgin
Plethora
Powder
Probably
Pulsar
Pumpkin
Pursuit
Queen
Recipient
Refrain
Refugee
Remarkable
Rye
Wry
Scrutiny
Secret
Seldom
Semicircle
Sigma
Sleigh
Slay
Sniffle
Special
Spooky
Strategic
Subsidy
Swamp
Syntax
Tangerine
Telepathy
Thesis
Tremendous
Twenty
Uncomfortable
Vague
Villain
Voluntary
Walnut
Warrior
Window
Zombie`;

const INTERMEDIATE_TEXT = `Abditive
Abdomen
Abhorrent
Abscond
Accomplishment
Accumulation
Adolescent
Adversity
Aerodynamic
Agriculture
Apostrophe
Articulate
Asphyxiation
Aspiration
Assumption
Asthma
Atmospheric
Beneficiary
Benevolence
Blizzard
Bronchitis
Brusque
Calibration
Candlelight
Caustic
Champagne
Charisma
Chlorophyll
Christmas
Cognitive
Colonel
Kernel
Combustible
Commodity
Concentration
Consumption
Contour
Controversial
Cuisine
Dauntless
Deployment
Derogatory
Detrimental
Diplomatic
Disappointment
Disconsolate
Division
Doctrine
Elaborate
Embarrassment
Embassy
Enchantment
Encore
Endeavor
Endeavour
Epiphany
Epsilon
Erratic
Euphoria
Exaggerate
Excalibur
Exorcism
Expenditure
Exponential
Extravagant
Fantasy
Favorable
Favourable
Featherweight
Fictitious
Fjord
Flamboyant
Fluorescent
Forthcoming
Frostbite
Fruition
Gastronomic
Gazebo
Gibberish
Gingerbread
Glacier
Gratitude
Gravestone
Hailstone
Heritage
Hexagonal
Hibernation
Hornswoggle
Hourglass
Humanitarian
Hypothesis
Ideological
Idiom
Imminent
Imprisonment
Independence
Indifference
Inhabitant
Intermediate
Intermission
Juxtaposition
Kangaroo
Legendary
Limousine
Livery
Mathematician
Melancholy
Metabolism
Methodology
Microorganism
Misconception
Mistletoe
Multiplication
Myopic
Nebulous
Necromancer
Negotiation
Neighboring
Neighbouring
Nonplussed
Notorious
Obituary
Oblivious
Opaque
Optimism
Palatine
Pantograph
Parallel
Participation
Passionate
Peppermint
Periodically
Personnel
Pestilence
Photographer
Pomegranate
Portfolio
Practitioner
Predominantly
Present
Problematic
Proclamation
Procrastinate
Pronunciation
Propaganda
Protocol
Pygmy
Ravenous
Recession
Reincarnation
Reliability
Residential
Resilience
Resurrection
Revelation
Rhythm
Ricochet
Sabotage
Sachet
Sashay
Sapphire
Scholarship
Sentimental
Separation
Shareholder
Significance
Skeleton
Snowflake
Solidarity
Spokesperson
Steadfast
Stereotype
Supposedly
Surrogate
Surveillance
Susceptible
Syllable
Symmetrical
Systematic
Technological
Thesaurus
Transaction
Translucent
Transparency
Transportation
Understand
Unprecedented
Validity
Venerate
Violation
Vulnerability
Wednesday
Wholeheartedly
Worthwhile`;

const HEATED_TEXT = `Abacaxi
Abasia
Accommodate
Acculturate
Aegis
Aforementioned
Aggrandize
Aggrandise
Agoraphobia
Agoraphobic
Ambidextrous
Ambiguous
Anaphylactic
Anemone
Anisosquaric
Apocryphal
Apothecary
Asphyxiation
Astigmatism
Asunder
Ataraxy
Attorney
Bandeau
Belvedere
Betwixt
Blatherskite
Bodacious
Brucellosis
Bucolic
Cacophony
Calamitous
Calumny
Capoeira
Capricious
Captious
Cerulean
Charcuterie
Chauffeur
Chronological
Cinematographer
Clandestine
Coalescence
Codicil
Colloquialism
Comeuppance
Commodore
Compunction
Consanguine
Consummate
Correspondence
Counterintuitive
Culvert
Cyrillic
Defenestration
Deleterious
Depilatory
Diminution
Discombobulate
Dodecahedron
Eloquent
Elysian
Elision
Epitome
Extraterrestrial
Facsimile
Fastidious
Fissiparous
Flummox
Fuchsia
Gentrification
Glaucomatous
Glockenspiel
Gobbledygook
Gobbledegook
Grandiloquent
Handkerchief
Harpsichord
Hemoglobin
Haemoglobin
Heterozygous
Hierarchy
Homeopathy
Homoeopathy
Homogeneous
Horticulturist
Hypermetropia
Iconoclast
Incandescent
Inchoate
Incoagulable
Indefatigable
Ingenious
Insinuate
Isometropia
Isthmus
Kaleidoscope
Languid
Legislation
Lexicography
Liaison
Lugubrious
Lymphangiography
Macabre
Magniloquent
Malapropism
Martyrdom
Mellifluous
Menagerie
Microminiaturisation
Milieu
Miniscule
Minuscule
Miscellaneous
Monochromatic
Monosyllabic
Multidimensionality
Municipal
Myriad
Narcissistic
Nauseous
Neuroplasticity
Nocturn
Nocturne
Nomenclature
Obfuscation
Paradigm
Parliamentary
Paroxysm
Pecuniary
Pessimistic
Phantasmagoria
Pharaoh
Farrow
Phenomenon
Phlegm
Photogeochemistry
Pirouette
Pneumatic
Polemic
Polychromatic
Polydactyly
Predecessor
Prestigious
Psychological
Puerile
Pugnacious
Querimony
Quixotry
Rambunctious
Rehabilitation
Reminiscence
Rendezvous
Sagacious
Sanguine
Sarcophagus
Scintillate
Semaphore
Sequacious
Sequoia
Silhouette
Simultaneous
Sovereignty
Subpoena
Subterranean
Supercentenarian
Supersede
Supercede
Syllepsis
Symbiosis
Syzygy
Tempestuous
Tetraphobia
Therapeutic
Thermionic
Thermoluminescence
Triphosphate
Ubiquitous
Uncharacteristic
Unintelligible
Verbatim
Vexatious
Vignette
Xenogeneic
Zephyr
Zygote`;

const GENIUS_TEXT = `Abdominothoracic
Absquatulate
Acetaminophen
Achromatophil
Achromatophilia
Acquiesce
Allotransplantation
Anachronistic
Aneurysmorrhaphy
Antediluvian
Arthroereisis
Ascosporogenous
Baccalaureate
Batrachophobia
Bogolanfini
Borborygmus
Bougainvillea
Bourgeoisie
Buckminsterfullerene
Bureaucracy
Chronopsychophysiology
Clinicoechocardiographic
Compartmentalization
-sation
Contradistinguish
Countermajoritarianism
Craniosynostosis
Cryptoendolithic
Dendrochronology
Deoxyribonucleic
Dichotomization
Eclaircissement
Effervescent
Electrotelethermometer
Entrepreneur
Ethnomethodology
Ethnopsychopharmacology
Flibbertigibbet
Fossiliferous
Frontoethmoidectomy
Geitonogamy
Geochronostratigraphical
Glyceraldehyde
Goniosynechialysis
Gubernatorial
Hemispherectomy
Hieroglyphics
Hypercholesterolemia
Hypergammaglobulinemia
Hypergonadotropic
Hyperpolysyllabic
Hypoparathyroidism
Incomprehensibility
Infinitesimal
Infundibulum
Institutionalization
Jurisprudence
Labyrinthine
Lepidopterology
Machiavellian
Mechanotransduction
Metonymic
Morphodifferentiation
Necrobiosislipoidica
Neuropsychological
Oligonucleotide
Onomatopoeia
Orthogeosyncline
Panproctocolectomy
Parallelogrammatic
Paraphernalia
Perspicacious
Photoreconnaissance
Plasmodiumfalciparum
Plenipotentiary
Portmanteau
Prestidigitation
Proceleusmatic
Prognostication
Pseudohyperaldosteronism
Pseudoparallelodromous
Pseudoriemannian
Psychotomimetic
Pulchritudinous
Pusillanimous
Quasiautobiographical
Quasquicentennial
Quindecasyllabic
Quoddamodotative
Radioallergosorbent
Radiometeorograph
Rhinorrhagia
Serendipity
Sesquipedalian
Soliloquy
Spectrophotometer
Subcompartmentalization
Subdermatoglyphic
Supererogatory
Superferromagnetism
Susurration
Temporomandibular
Thalassophobia
Thermochromatography
Tintinnabulation
Transinstitutionalization
Trinitrotoluene
Utilitarianism
Verisimilitude
Worcestershire
Xiphiplastron
Xylotypographic`;

const SUPER_HARD_TEXT = `Acetylglucocoroglaucigenin
Adrenocorticotropin
-trophin
Anthropomorphization
-sation
Antidisestablishmentarianism
Antixerophthalmic
Autothaumaturgist
Bourgeoisification
Bromochlorodifluoromethane
Canaliculodacryocystorhinostomy
Chargoggagoggmanchauggagoggchaubunagungamaugg
Cholangiocholecystocholedochectomy
Cholangiopancreatography
Chondromyxohemangioendotheliosarcoma
Convolvulaceous
Corticopontocerebellar
Counterimmunoelectrophoresis
Dehydrothiotoluidine
Dermatofibrosarcomaprotuberans
Dextrodeorsumversion
Dichlorodiphenyltrichloroethane
Diisopropylfluorophosphate
Eellogofusciouhipoppokunurious
Encephalocraniocutaneouslipomatosis
Erythrocytapheresis
Ferriprotoporphyrin
Floccinaucinihilipilification
Fluorotetraferriphlogopite
Gastroenterologist
Gegenstandstheorie
Hematospectrophotometrically
Haematospectrophotometrically
Hexakosioihexekontahexaphobia
Hippopotomonstrosesquipedaliophobia
-quippedaliophobia
Honorificabilitudinity
Honourificabilitudinity
Hypothalamicpituitaryadrenocortical
Immunoelectrochemiluminescence
Inositolphosphorylceramide
Laparohysterosalpingooophorectomy
Laryngotracheobronchitis
Loncastuximabtesirine
Lymphangioleiomyomatosis
Micropachycephalosaurus
Neohesperidindihydrochalcone
Nonanonacontanonactanonaliagon
Nucleotidylexotransferase
Otorhinolaryngological
Photoplethysmography
Pneumoencephalography
Pneumonoultramicroscopicsilicovolcanoconiosis
Polyphiloprogenitive
Pseudopseudohypoparathyroidism
Pseudorhombicuboctahedron
Psychoneuroendocrinological
Psychoneuroimmunology
Psychophysicotherapeutics
Pyrrolizidinealkaloidosis
Ribulosebisphosphatecarboxylaseoxygenase
Sclerectoiridectomy
Spectrophotofluorometry
Sphenopalatineganglioneuralgia
Sphygmomanometer
Stereoelectroencephalography
Supercalifragilisticexpialidocious
Thyroparathyroidectomy
Tonsillopharyngitis
Uvulopalatopharyngoplasty
Ventriculocisternostomy`;

// Local Definitions for Offline Support
// Updated to include words from Heated, Genius, and Polymath lists
const LOCAL_DEFINITIONS: Record<string, string> = {
  // --- Heated ---
  abacaxi: "A large, sweet pineapple grown in Brazil.",
  abasia: "Inability to walk due to a lack of motor coordination.",
  accommodate: "Fit in with the wishes or needs of.",
  acculturate: "Assimilate to a different culture, typically the dominant one.",
  aegis:
    "The protection, backing, or support of a particular person or organization.",
  aggrandize:
    "Enhance the reputation or power of someone beyond what is justified.",
  ambidextrous: "Able to use the right and left hands equally well.",
  apocryphal:
    "of doubtful authenticity, although widely circulated as being true.",
  ataraxy: "A state of serene calmness.",
  blatherskite: "A person who talks at great length without making much sense.",
  bodacious: "Excellent, admirable, or attractive.",
  bucolic:
    "Relating to the pleasant aspects of the countryside and country life.",
  cacophony: "A harsh, discordant mixture of sounds.",
  capricious: "Given to sudden and unaccountable changes of mood or behavior.",
  cerulean: "Deep blue in color like a clear sky.",
  clandestine: "Kept secret or done secretively.",
  codicil:
    "An addition or supplement that explains, modifies, or revokes a will.",
  defenestration: "The act of throwing someone or something out of a window.",
  deleterious: "Causing harm or damage.",
  discombobulate: "Disconcert or confuse (someone).",
  dodecahedron: "A three-dimensional shape having twelve plane faces.",
  elysian: "Relating to or characteristic of heaven or paradise.",
  fissiparous:
    "Inclined to cause or undergo division into separate parts or groups.",
  flummox: "Perplex (someone) greatly; bewilder.",
  glockenspiel:
    "A musical percussion instrument having a set of tuned metal pieces.",
  gobbledygook:
    "Language that is meaningless or is made unintelligible by excessive use of abstruse technical terms.",
  grandiloquent: "Pompous or extravagant in language, style, or manner.",
  horticulturist:
    "An expert in or student of garden cultivation and management.",
  iconoclast: "A person who attacks cherished beliefs or institutions.",
  indefatigable: "Persisting tirelessly.",
  lugubrious: "Looking or sounding sad and dismal.",
  mellifluous: "(of a voice or words) sweet or musical; pleasant to hear.",
  milieu: "A person's social environment.",
  nocturne:
    "A short composition of a romantic or dreamy character suggestive of night.",
  obfuscation:
    "The action of making something obscure, unclear, or unintelligible.",
  paroxysm:
    "A sudden attack or violent expression of a particular emotion or activity.",
  phantasmagoria:
    "A sequence of real or imaginary images like those seen in a dream.",
  polemic: "A strong verbal or written attack on someone or something.",
  puerile: "Childishly silly and trivial.",
  quixotry: "Visionary or impractical schemes or ideas.",
  rambunctious: "Uncontrollably exuberant; boisterous.",
  sagacious: "Having or showing keen mental discernment and good judgment.",
  sanguine:
    "Optimistic or positive, especially in an apparently bad or difficult situation.",
  scintillate: "Emit flashes of light; sparkle.",
  sequoia: "A redwood tree, especially the giant sequoia.",
  subpoena: "A writ ordering a person to attend a court.",
  syzygy: "A conjunction or opposition, especially of the moon with the sun.",
  ubiquitous: "Present, appearing, or found everywhere.",
  zephyr: "A soft gentle breeze.",
  zygote: "A diploid cell resulting from the fusion of two haploid gametes.",

  // --- Genius ---
  absquatulate: "To leave abruptly.",
  acetaminophen: "An analgesic drug used to treat headaches, arthritis, etc.",
  acquiesce: "Accept something reluctantly but without protest.",
  anachronistic: "Belonging to a period other than that being portrayed.",
  antediluvian: "Of or belonging to the time before the biblical Flood.",
  borborygmus:
    "A rumbling or gurgling noise made by the movement of fluid and gas in the intestines.",
  bougainvillea:
    "An ornamental climbing plant widely cultivated in the tropics.",
  bourgeoisie:
    "The middle class, typically with reference to its perceived materialistic values.",
  bureaucracy:
    "A system of government in which most of the important decisions are made by state officials.",
  effervescent: "Giving off bubbles; fizzy.",
  entrepreneur: "A person who organizes and operates a business or businesses.",
  flibbertigibbet: "A frivolous, flighty, or excessively talkative person.",
  gubernatorial:
    "Relating to a state governor or the office of state governor.",
  hieroglyphics: "Enigmatic or incomprehensible symbols or writing.",
  machiavellian: "Cunning, scheming, and unscrupulous, especially in politics.",
  onomatopoeia:
    "The formation of a word from a sound associated with what is named.",
  perspicacious: "Having a ready insight into and understanding of things.",
  plenipotentiary:
    "A person, especially a diplomat, invested with the full power of independent action.",
  portmanteau:
    "A large trunk or suitcase, typically made of stiff leather and opening into two equal parts.",
  prestidigitation: "Magic tricks performed as entertainment.",
  prognostication: "The action of foretelling or prophesying future events.",
  pulchritudinous: "Beautiful.",
  pusillanimous: "Showing a lack of courage or determination; timid.",
  serendipity:
    "The occurrence and development of events by chance in a happy or beneficial way.",
  sesquipedalian: "Characterized by long words; long-winded.",
  soliloquy: "An act of speaking one's thoughts aloud when by oneself.",
  susurration: "Whispering, murmuring, or rustling.",
  utilitarianism:
    "The doctrine that actions are right if they are useful or for the benefit of a majority.",
  verisimilitude: "The appearance of being true or real.",
  worcestershire: "A savory sauce containing soy sauce and vinegar.",

  // --- Polymath ---
  anthropomorphization:
    "The attribution of human characteristics or behavior to a god, animal, or object.",
  antidisestablishmentarianism:
    "Opposition to the disestablishment of the Church of England.",
  autothaumaturgist:
    "One who pretends to be mystically self-taught or self-enlightened.",
  convolvulaceous: "Belonging to the morning glory family of plants.",
  floccinaucinihilipilification:
    "The action or habit of estimating something as worthless.",
  gastroenterologist:
    "A medical practitioner qualified to diagnose and treat disorders of the stomach and intestines.",
  gegenstandstheorie: "A theory of objects or items, associated with Meinong.",
  hippopotomonstrosesquipedaliophobia: "The fear of long words.",
  honorificabilitudinity: "The state of being able to achieve honours.",
  micropachycephalosaurus: "A genus of small herbivorous dinosaur.",
  otorhinolaryngological:
    "Relating to the study of diseases of the ear, nose, and throat.",
  pneumonoultramicroscopicsilicovolcanoconiosis:
    "A lung disease caused by inhaling very fine ash and sand dust.",
  psychoneuroimmunology:
    "The study of the effect of the mind on health and resistance to disease.",
  sphygmomanometer: "An instrument for measuring blood pressure.",
  supercalifragilisticexpialidocious: "Extraordinarily good; wonderful.",
  thyroparathyroidectomy:
    "Surgical removal of the thyroid and parathyroid glands.",
  ventriculocisternostomy:
    "A surgical operation to create a communication between a cerebral ventricle and a cisterna magna.",

  // --- Common Homophones & others ---
  their:
    "Belonging to or associated with the people or things previously mentioned.",
  there: "In, at, or to that place or position.",
  "they're": "Contraction of 'they are'.",
  to: "Expressing motion in the direction of.",
  too: "To a higher degree than is desirable.",
  two: "The number 2.",
  phish:
    "The fraudulent practice of sending emails purporting to be from reputable companies.",
  newb: "A newcomer or novice.",
  noob: "A person who is inexperienced in a particular sphere or activity.",
  psi: "The twenty-third letter of the Greek alphabet.",
  sigh: "Emit a long, deep, audible breath expressing sadness, relief, or tiredness.",
};

const parseWords = (text: string) =>
  text
    .split("\n")
    .map((w) => w.trim())
    .filter((w) => w.length > 0 && !w.startsWith("-"));

// Sorted Word Lists (Shortest to Longest)
// We sort by length so "nextWord" can pick based on streak.
const sortByLength = (arr: string[]) => arr.sort((a, b) => a.length - b.length);

const baby = sortByLength(parseWords(BABY_TEXT));
const cakewalk = sortByLength(parseWords(CAKEWALK_TEXT));
const learner = sortByLength(parseWords(LEARNER_TEXT));
const intermediate = sortByLength(parseWords(INTERMEDIATE_TEXT));
const heated = sortByLength(parseWords(HEATED_TEXT));
const genius = sortByLength(parseWords(GENIUS_TEXT));
const polymath = sortByLength(parseWords(SUPER_HARD_TEXT));
const omniscient = sortByLength([
  ...baby,
  ...cakewalk,
  ...learner,
  ...intermediate,
  ...heated,
  ...genius,
  ...polymath,
]);

export const MODE_ORDER = [
  "baby",
  "cakewalk",
  "learner",
  "intermediate",
  "heated",
  "genius",
  "polymath",
  "omniscient",
];

export const wordBank: Record<string, string[]> = {
  baby,
  cakewalk,
  learner,
  intermediate,
  heated,
  genius,
  polymath,
  omniscient,
};

// Determine which difficulty a word belongs to (for dynamic stars in Omniscient mode)
// Returns the HIGHEST difficulty the word appears in (for words that appear in multiple lists)
export const getWordDifficulty = (word: string): string => {
  const lowerWord = word.toLowerCase();

  // Check in order from hardest to easiest so we return the highest difficulty
  if (polymath.map((w) => w.toLowerCase()).includes(lowerWord))
    return "polymath";
  if (genius.map((w) => w.toLowerCase()).includes(lowerWord)) return "genius";
  if (heated.map((w) => w.toLowerCase()).includes(lowerWord)) return "heated";
  if (intermediate.map((w) => w.toLowerCase()).includes(lowerWord))
    return "intermediate";
  if (learner.map((w) => w.toLowerCase()).includes(lowerWord)) return "learner";
  if (cakewalk.map((w) => w.toLowerCase()).includes(lowerWord))
    return "cakewalk";
  if (baby.map((w) => w.toLowerCase()).includes(lowerWord)) return "baby";

  return "baby"; // fallback
};

const HOMOPHONES: Record<string, string[]> = {
  air: ["heir"],
  heir: ["air"],
  ball: ["bawl"],
  bawl: ["ball"],
  be: ["bee"],
  bee: ["be"],
  blue: ["blew"],
  blew: ["blue"],
  eye: ["aye", "i"],
  aye: ["eye", "i"],
  flour: ["flower"],
  flower: ["flour"],
  know: ["no"],
  no: ["know"],
  knight: ["night"],
  night: ["knight"],
  mail: ["male"],
  male: ["mail"],
  pair: ["pear", "pare"],
  pear: ["pair", "pare"],
  pare: ["pair", "pear"],
  peace: ["piece"],
  piece: ["peace"],
  plain: ["plane"],
  plane: ["plain"],
  rain: ["reign", "rein"],
  reign: ["rain", "rein"],
  rein: ["rain", "reign"],
  read: ["red"],
  red: ["read"],
  right: ["write", "rite"],
  write: ["right", "rite"],
  sea: ["see"],
  see: ["sea"],
  son: ["sun"],
  sun: ["son"],
  tail: ["tale"],
  tale: ["tail"],
  to: ["too", "two"],
  too: ["to", "two"],
  two: ["to", "too"],
  way: ["weigh"],
  weigh: ["way"],
  week: ["weak"],
  weak: ["week"],
  phish: ["fish"],
  fish: ["phish"],
  newb: ["noob"],
  noob: ["newb"],
  sighs: ["size"],
  size: ["sighs"],
  psi: ["sigh"],
  sigh: ["psi"],
  noble: ["nobel"],
  nobel: ["noble"],
  wrought: ["rot"],
  rot: ["wrought"],
  pharaoh: ["farrow"],
  farrow: ["pharaoh"],
  colonel: ["kernel"],
  kernel: ["colonel"],
  armor: ["armour"],
  armour: ["armor"],
  center: ["centre"],
  centre: ["center"],
  color: ["colour"],
  colour: ["color"],
  flavor: ["flavour"],
  flavour: ["flavor"],
  harbor: ["harbour"],
  harbour: ["harbor"],
  neighbor: ["neighbour"],
  neighbour: ["neighbor"],
  honor: ["honour"],
  honour: ["honor"],
  vain: ["vein"],
  vein: ["vain"],
  adrenocorticotropin: ["adrenocorticotrophin"],
  adrenocorticotrophin: ["adrenocorticotropin"],
  honorificabilitudinity: ["honourificabilitudinity"],
  honourificabilitudinity: ["honorificabilitudinity"],
  hematospectrophotometrically: ["haematospectrophotometrically"],
  haematospectrophotometrically: ["hematospectrophotometrically"],
};

const normalizeSuffix = (word: string) => {
  return word
    .toLowerCase()
    .replace(/isation/g, "ization")
    .replace(/ise$/g, "ize")
    .replace(/yse$/g, "yze")
    .replace(/our/g, "or")
    .replace(/re$/g, "er");
};

export const checkAnswer = (target: string, input: string): boolean => {
  const normTarget = normalizeSuffix(target.trim());
  const normInput = normalizeSuffix(input.trim());

  if (normTarget === normInput) return true;

  const lowerTarget = target.toLowerCase();
  const lowerInput = input.toLowerCase();

  if (HOMOPHONES[lowerTarget]) {
    if (HOMOPHONES[lowerTarget].includes(lowerInput)) return true;
    const matches = HOMOPHONES[lowerTarget].some(
      (h) => normalizeSuffix(h) === normInput,
    );
    if (matches) return true;
  }

  return false;
};

export const fetchDefinition = async (word: string): Promise<string> => {
  const lowerWord = word.toLowerCase().trim();
  if (LOCAL_DEFINITIONS[lowerWord]) {
    return LOCAL_DEFINITIONS[lowerWord];
  }

  try {
    const res = await fetch(
      `https://api.dictionaryapi.dev/api/v2/entries/en/${word}`,
    );
    if (!res.ok) throw new Error("No def");
    const data = await res.json();
    return (
      data[0]?.meanings[0]?.definitions[0]?.definition ||
      "Listen carefully to the pronunciation."
    );
  } catch (e) {
    return "Listen carefully to the pronunciation.";
  }
};

let speakId = 0;

export const getTitle = (corrects: number, wins: number): string => {
  if (corrects >= 50000) return "Queen Bee";
  if (corrects >= 10000) return "Hive Master";
  if (wins >= 1000) return "Hive Champion";
  if (corrects >= 1000 && wins >= 100) return "Busy Bee";
  return "Newbee";
};

/** Audio State Management */
let currentAudio: HTMLAudioElement | null = null;
let activeUtterance: SpeechSynthesisUtterance | null = null;

export const stopAudio = () => {
  speakId++; // Invalidate any pending async audio
  if (currentAudio) {
    currentAudio.pause();
    currentAudio.currentTime = 0;
    currentAudio = null;
  }
  if (typeof window !== "undefined" && window.speechSynthesis) {
    window.speechSynthesis.cancel();
  }
  activeUtterance = null;
};

/** Maps word variations to available audio files */
const getAlternateAudioName = (word: string): string | null => {
  const lower = word.toLowerCase();

  if (lower === "adrenocorticotropin") return "adrenocorticotrophin";
  if (lower === "adrenocorticotrophin") return "adrenocorticotropin";
  if (lower === "honorificabilitudinity") return "honourificabilitudinity";
  if (lower === "honourificabilitudinity") return "honorificabilitudinity";
  if (lower === "hematospectrophotometrically")
    return "haematospectrophotometrically";
  if (lower === "haematospectrophotometrically")
    return "hematospectrophotometrically";

  if (lower.endsWith("or")) {
    return lower.replace(/or$/, "our");
  }
  if (lower.endsWith("our")) {
    return lower.replace(/our$/, "or");
  }
  return null;
};

// IMPROVED SPEAK FUNCTION

// Audio Deduplication State
let lastSpokenWord: string | null = null;
let lastSpokenTime: number = 0;

export const speak = async (
  word: string,
  volume: number = 1.0,
  force: boolean = false,
): Promise<void> => {
  const now = Date.now();
  // Dedupe: If same word requested within 1s, and not forced, ignore
  if (!force && word === lastSpokenWord && now - lastSpokenTime < 1000) {
    console.log(`[Audio] Ignoring duplicate speak request for "${word}"`);
    return;
  }

  lastSpokenWord = word;
  lastSpokenTime = now;

  stopAudio(); // Increments speakId
  const myId = speakId; // Capture this specific attempt ID

  const lowerWord = word.toLowerCase();

  const playBrowserTTS = (): Promise<void> => {
    return new Promise<void>((resolve) => {
      // Abort if a new speak request came in
      if (speakId !== myId) {
        resolve();
        return;
      }

      if (typeof window !== "undefined" && window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }

      const utterance = new SpeechSynthesisUtterance(word);
      activeUtterance = utterance;
      utterance.volume = volume;
      utterance.rate = 0.9;

      utterance.onend = () => {
        activeUtterance = null;
        resolve();
      };
      utterance.onerror = () => {
        activeUtterance = null;
        resolve();
      };

      // Verification before starting
      if (speakId === myId) {
        window.speechSynthesis.speak(utterance);
      } else {
        resolve();
      }
    });
  };

  const attemptPlayAudioFile = (fileName: string): Promise<boolean> => {
    return new Promise((resolve) => {
      // Abort if outdated (global check)
      if (speakId !== myId) {
        resolve(false);
        return;
      }

      // Local closure flag for this specific audio attempt
      let isCancelled = false;

      const audioPath = `/audio/${fileName}.mp3`;
      const audio = new Audio(audioPath);

      // Force stop previous
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      currentAudio = audio;
      audio.volume = volume;

      // Use a timeout to detect if metadata fails or file is missing
      const timeout = setTimeout(() => {
        // TIMEOUT: strictly kill this attempt
        isCancelled = true; // Mark as dead

        audio.oncanplaythrough = null;
        audio.onerror = null;
        audio.pause();
        audio.src = ""; // Stop loading
        try {
          audio.load();
        } catch (e) {
          /* ignore */
        }

        if (currentAudio === audio && speakId === myId) {
          currentAudio = null;
        }
        resolve(false);
      }, 1000);

      audio.oncanplaythrough = () => {
        // If timeout killed us, stop immediately
        if (isCancelled) return;

        clearTimeout(timeout);

        // CRITICAL: Only play if this is still the active audio AND ID matches
        if (currentAudio === audio && speakId === myId) {
          const playPromise = audio.play();
          if (playPromise !== undefined) {
            playPromise.then(() => resolve(true)).catch(() => resolve(false));
          } else {
            resolve(true);
          }
        } else {
          // We were stopped/replaced/timed-out
          resolve(false);
        }
      };

      audio.onerror = () => {
        if (isCancelled) return;
        clearTimeout(timeout);
        resolve(false);
      };
    });
  };

  // Logic: Try MP3 -> Alternate -> TTS
  let success = await attemptPlayAudioFile(lowerWord);
  if (speakId !== myId) return; // Stop if interrupted

  if (!success) {
    const alt = getAlternateAudioName(word);
    if (alt) success = await attemptPlayAudioFile(alt);
  }

  if (speakId !== myId) return; // Stop if interrupted

  if (!success) {
    // Check one last time if we haven't been stopped
    if (activeUtterance === null && speakId === myId) {
      console.warn(`Local audio failed for "${word}". Playing TTS.`);
      await playBrowserTTS();
    }
  } else {
    // Audio file played successfully
    console.log(`Playing local audio for "${word}"`);
  }
};
